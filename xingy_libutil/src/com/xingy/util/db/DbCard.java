package com.xingy.util.db;

import android.database.sqlite.SQLiteDatabase;

import com.xingy.util.Config;
import com.xingy.util.Log;
import com.xingy.util.ToolUtil;
import com.xingy.util.cache.SDCache;

import java.util.Date;

public class DbCard extends Database{
	
	private static final String LOG_TAG =  DbCard.class.getName();
	
	private static boolean HAVECHECKED = false;
	
	/**
	 * �????�???��?��??�????�???�路�?�?�???��?��??�???????�????�?�????�???��?��??就�?????checkUpdate()??��?��????��?��??�??????????�?�????�?�???��?��??就�?????onCreate()??��?��????��??�?
	 */
	public void init(){
		if( null != core &&  core.isOpen() ){
			return;
		}
		
		SDCache storage = new SDCache();
		String path = storage.getTempPath();//�???????就�??getRootPath();
		
		if( null == path ){
			Log.e(LOG_TAG, "init|getTempPath failed");
			
			return;
		}
		
		boolean exists = storage.fileExsits( Config.SD_DATABASE_NAME );
		
		core = SQLiteDatabase.openOrCreateDatabase( path + Config.SD_DATABASE_NAME, null);
		
		if( exists ){
			checkUpdate();
		}
		else{
			onCreate( );
		}
	}
	/**
	 * ???建�?��??�??????��??�?�?并�????��??�???��?????
	 */
	private void onCreate() {
		try{
			long now = new Date().getTime();
			long exipre = now + 3600 * 1000 * 24 * 365 * 10;
			core.execSQL("create table ifnot exists page_cache(id varchar(50) primary key, content TEXT, row_create_time INTEGER, row_expire_time INTEGER)");
			core.execSQL("insert into page_cache(id, content, row_create_time, row_expire_time) values(?,?,?,?)", new String[]{Config.SD_DATABASE_VERSION_NAME, String.valueOf( Config.SD_DATABASE_VERSION ), String.valueOf( now ), String.valueOf( exipre ) } );
		}catch(Exception ex){
			Log.e(LOG_TAG, "onCreate|page_cache|" + ToolUtil.getStackTraceString(ex));;
		};
		
	}
	/**
	 *�???��???????��??�?????????????系�??�?�????????????????�???��??�??????????为空�?记�?????�???��??�?�??????????�?�???��?��??�????onUpadte()??��?��??�??????��??�??????�表??????建�??
	 */
	private void checkUpdate() {
		
		if( HAVECHECKED)	return;
		
		HAVECHECKED = true;
		
		String version = getValue("select content from page_cache where id = ?",  new String[]{ Config.SD_DATABASE_VERSION_NAME });
		
		if( null == version ){
			Log.e(LOG_TAG, "checkUpdate|value is empty" + errMsg);
			return;
		}
		
		if( Integer.valueOf(version) != Config.SD_DATABASE_VERSION ){
			onUpdate();
		}
		
	}
	
	/**
	 * ?????��????????�?�???��????��??�??????��????????�?�?�????onCreate()??��?��??�??????��??�?????????��??建�??
	 */
	private void onUpdate() {
		try{
			core.execSQL("DROP TABLE IF EXISTS page_cache");
		}catch(Exception ex){
			Log.e(LOG_TAG, "onUpgrade|page_cache|" + ToolUtil.getStackTraceString(ex));;
		};
		
		onCreate();
	}
		
}
